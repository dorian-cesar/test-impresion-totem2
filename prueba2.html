<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imprimir Boleto RawBT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 600px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .ticket-preview {
            background-color: #e9ecef;
            border: 1px dashed #6c757d;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            font-size: 0.9em;
            color: #343a40;
        }

        h2 {
            color: #007bff;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="mb-4 text-center">Impresión de Boleto con RawBT</h2>
        <p class="text-center">Haz clic en el botón para enviar el boleto a imprimir usando RawBT.</p>

        <div class="d-grid gap-2">
            <button id="printTicketBtn" class="btn btn-primary btn-lg">
                <i class="bi bi-printer"></i> Imprimir Boleto
            </button>
        </div>

        <hr>

        <h5 class="mt-4 text-center">Previsualización del Contenido (Texto Plano)</h5>
        <div id="ticketContentPreview" class="ticket-preview">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script>
        $(document).ready(function () {
            const ticketData = {
                boleto: "KP10332",
                reserva: "TS250527105448709VIFX",
                id: "7597",
                rut: "Sin RUT",
                idBus: "60959544",
                destino: "Santiago",
                fechaViaje: "2025-05-29",
                asiento: "11",
                estado: "Generado Manualmente",
                terminal: "12345678",
                totalTransaccion: "3996",
                codigoTransaccion: "SIM908264",
                codigoAutorizacion: "128302",
                tipoTarjeta: "CR"
            };

            function appendBytes(arr1, arr2) {
                const merged = new Uint8Array(arr1.length + arr2.length);
                merged.set(arr1);
                merged.set(arr2, arr1.length);
                return merged;
            }

            function generateEscPosCommands(data) {
                let escPos = new Uint8Array(0);
                const encoder = new TextEncoder();

                // Inicializar impresora
                escPos = appendBytes(escPos, new Uint8Array([0x1B, 0x40])); // ESC @ - Reset printer
                
                // Configurar alineación izquierda
                escPos = appendBytes(escPos, new Uint8Array([0x1B, 0x61, 0x00])); // ESC a 0 - Left alignment

                // Encabezado con texto grande centrado
                escPos = appendBytes(escPos, new Uint8Array([0x1B, 0x61, 0x01])); // Centrar
                escPos = appendBytes(escPos, new Uint8Array([0x1D, 0x21, 0x11])); // Texto doble altura y ancho
                escPos = appendBytes(escPos, encoder.encode("EMPRESA DE BUSES\n"));
                escPos = appendBytes(escPos, new Uint8Array([0x1D, 0x21, 0x00])); // Volver a tamaño normal
                escPos = appendBytes(escPos, new Uint8Array([0x1B, 0x61, 0x00])); // Alinear a la izquierda
                escPos = appendBytes(escPos, encoder.encode("\n")); // Espacio adicional

                // Resto del encabezado
                escPos = appendBytes(escPos, encoder.encode("RUT: 12345678-9\n"));
                escPos = appendBytes(escPos, encoder.encode("Boleta Electronica\n\n"));

                // Datos del boleto
                const lines = [
                    `Boleto: ${data.boleto}`,
                    `Reserva: ${data.reserva}`,
                    `ID: ${data.id}`,
                    `RUT: ${data.rut}`,
                    `Id Bus: ${data.idBus}`,
                    `Destino: ${data.destino}`,
                    `Fecha: ${data.fechaViaje}`,
                    `Asiento: ${data.asiento}`,
                    `Estado: ${data.estado}`,
                    `Terminal: ${data.terminal}`,
                    `Total: $${data.totalTransaccion}`,
                    `Transaccion: ${data.codigoTransaccion}`,
                    `Autorizacion: ${data.codigoAutorizacion}`,
                    `Tarjeta: ${data.tipoTarjeta}`,
                ];
                
                lines.forEach(line => {
                    escPos = appendBytes(escPos, encoder.encode(line + "\n"));
                });

                // Línea divisoria
                escPos = appendBytes(escPos, encoder.encode("-------------------------------------\n\n"));

                // Texto del código de barras
                escPos = appendBytes(escPos, encoder.encode("Codigo de Barras: " + data.boleto + "\n\n"));

                // Configuración del código de barras (Code128)
                escPos = appendBytes(escPos, new Uint8Array([0x1D, 0x68, 0x50])); // Altura
                escPos = appendBytes(escPos, new Uint8Array([0x1D, 0x77, 0x02])); // Ancho
                escPos = appendBytes(escPos, new Uint8Array([0x1D, 0x48, 0x02])); // Mostrar texto debajo
                escPos = appendBytes(escPos, new Uint8Array([0x1D, 0x6B, 0x49, data.boleto.length + 2])); // Code128
                escPos = appendBytes(escPos, new Uint8Array([0x7B, 0x42])); // Inicio Code B
                escPos = appendBytes(escPos, encoder.encode(data.boleto)); // Datos
                escPos = appendBytes(escPos, new Uint8Array([0x00])); // Terminador
                escPos = appendBytes(escPos, encoder.encode("\n\n"));

                // Mensaje final centrado
                escPos = appendBytes(escPos, new Uint8Array([0x1B, 0x61, 0x01])); // Centrar
                escPos = appendBytes(escPos, encoder.encode("¡Gracias por preferirnos!\n\n"));

                // Avanzar papel y cortar
                escPos = appendBytes(escPos, new Uint8Array([0x1B, 0x64, 0x04])); // Avanzar 4 líneas
                escPos = appendBytes(escPos, new Uint8Array([0x1D, 0x56, 0x00])); // Cortar papel
                
                return escPos;
            }

            function uint8ToBase64(uint8arr) {
                let binary = "";
                for (let i = 0; i < uint8arr.length; i++) {
                    binary += String.fromCharCode(uint8arr[i]);
                }
                return btoa(binary);
            }

            function displayPreview(data) {
                const text = `       EMPRESA DE BUSES

RUT: 12345678-9
Boleta Electronica

Boleto: ${data.boleto}
Reserva: ${data.reserva}
ID: ${data.id}
RUT: ${data.rut}
Id Bus: ${data.idBus}
Destino: ${data.destino}
Fecha: ${data.fechaViaje}
Asiento: ${data.asiento}
Estado: ${data.estado}
Terminal: ${data.terminal}
Total: $${data.totalTransaccion}
Transaccion: ${data.codigoTransaccion}
Autorizacion: ${data.codigoAutorizacion}
Tarjeta: ${data.tipoTarjeta}
-------------------------------------

[acá va el codigo de barras]

¡Gracias por preferirnos!`;
                $('#ticketContentPreview').text(text);
            }

            displayPreview(ticketData);

            $('#printTicketBtn').on('click', function () {
                try {
                    const escPosBytes = generateEscPosCommands(ticketData);
                    const base64EscPos = uint8ToBase64(escPosBytes);
                    const rawbtUrl = `rawbt:base64,${base64EscPos}`;
                    window.location.href = rawbtUrl;
                } catch (error) {
                    alert("Error: " + error.message);
                    console.error(error);
                }
            });
        });
    </script>
</body>

</html>